language: generic

sudo: required

dist: xenial

os:
  - linux

env:
  - LLVM_VERSION=40
  - LLVM_VERSION=50
  - LLVM_VERSION=60
  - LLVM_VERSION=70
  - LLVM_VERSION=80

jobs:
  include:
    - compiler: gcc
      name: 'Native builds'
      before_install:
        - ./scripts/travis.sh "$TRAVIS_OS_NAME" initialize

      script:
        - pyenv global 3.7.1
        - ./scripts/travis.sh "$TRAVIS_OS_NAME" build "$LLVM_VERSION"
    - services:
        - docker
      name: 'Docker build'
      env: LLVM_VERSION=80
      script:
        - docker build -t rellic-decomp --build-arg LLVM_VERSION=8.0 .
        - |
          docker run --rm -t \
            -v "$(pwd)":/test -w /test \
            -u "$(id -u)":"$(id -g)" \
            --entrypoint /opt/rellic/libraries/llvm/bin/clang \
            rellic-decomp:latest -emit-llvm -c ./tests/tools/decomp/issue_4.c -o ./tests/tools/decomp/issue_4.bc
        - |
          docker run --rm -t \
            -v "$(pwd)":/test -w /test \
            -u "$(id -u)":"$(id -g)" \
            rellic-decomp:latest --input ./tests/tools/decomp/issue_4.bc --output /dev/stdout
